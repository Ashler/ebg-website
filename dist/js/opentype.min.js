function fontPreviewElement(){return $("#font-preview")}function styleKeys(){return["-moz-font-feature-settings","-ms-font-feature-settings","-o-font-feature-settings","-webkit-font-feature-settings","font-feature-settings","font-style","font-weight"]}function setupFeatures(){function e(e){-1==n(e)&&i.push({setting:e})}function t(e){var t=n(e);-1!=t&&i.splice(t,1)}function n(e){for(var t=0;t<r();t++)if(i[t].setting==e)return t;return-1}function r(){return i.length}function a(){var e="";return 0==r()?e:(i.forEach(function(t){e+='"'+t.setting+'" 1, '},this),s(e))}function s(e){return e.replace(/,\s*$/,"")}function o(){var e=a();return{"-moz-font-feature-settings":e,"-ms-font-feature-settings":e,"-o-font-feature-settings":e,"-webkit-font-feature-settings":e,"font-feature-settings":e}}var i=[];return{add:e,remove:t,size:r,asString:a,forEveryBrowser:o}}function applyFeatureStyles(e,t,n){if(0!=fontPreviewElement().text().length){var r=setupSelectionForFeatureAppliance(),a=r.selection,s=r.range,o=$(a.anchorNode),i=$(a.focusNode);if(n){var l=n.split(":")[0].trim(),f=n.split(":")[1].trim(),c={};c[l]=t?f:""}if(o.is("#font-preview")&&i.is("#font-preview")&&(selectWholeText(a,s),o=$(a.anchorNode),i=$(a.focusNode)),isBackwards(a)){var d=o;o=i,i=d,a.removeAllRanges(),a.addRange(s)}o.parent().is("span")&&(o=o.parent()),i.parent().is("span")&&(i=i.parent());var u=o,p=i;if(!o.is(i)){if(o.is("span")){w=spans[o.attr("data-id")];if(a.anchorOffset>0){var v=(S=w.text()).slice(0,a.anchorOffset),g=S.slice(a.anchorOffset,S.length),h=w.features,m=w.css(styleKeys());e&&(t?h.add(e):h.remove(e)),(A=createSpanWith(g,h,$.extend(m,c))).insertAfter(w),u=A,w.text(v)}else e?(t?w.features.add(e):w.features.remove(e),w.css(w.features.forEveryBrowser())):c&&w.css(c),u=w;o=w}else{h=setupFeatures();e&&(t?h.add(e):h.remove(e));var w=createSpanWith("",h,c),x=o.text();w.text(x.slice(a.anchorOffset,o.text().length)),w.insertAfter(o),o.replaceWith(x.slice(0,a.anchorOffset)),u=o=w}for(o=$(o[0].nextSibling);!o.is(i);){if(o.is("span")){w=spans[o.attr("data-id")];e?(t?w.features.add(e):w.features.remove(e),w.css(w.features.forEveryBrowser())):c&&w.css(c)}else{h=setupFeatures();e&&(t?h.add(e):h.remove(e));w=createSpanWith(o.text(),h,c).insertAfter(o);o.remove(),o=w}o=$(o[0].nextSibling)}if(o.is("span")){var S=(w=spans[o.attr("data-id")]).text();if(a.focusOffset<S.length){var g=S.slice(0,a.focusOffset),y=S.slice(a.focusOffset,S.length),h=w.features,m=w.css(styleKeys());e&&(t?h.add(e):h.remove(e));var A=createSpanWith(g,h,$.extend(m,c));A.insertBefore(w),p=A,w.text(y)}else e?(t?w.features.add(e):w.features.remove(e),w.css(w.features.forEveryBrowser())):c&&w.css(c),p=w}else{h=setupFeatures();e&&(t?h.add(e):h.remove(e));var w=createSpanWith("",h,c),x=o.text();w.text(x.slice(0,a.focusOffset)),w.insertBefore(o),o.replaceWith(x.slice(a.focusOffset,x.length)),p=w}return fontPreviewElement()[0].normalize(),s.setStart(u[0].childNodes[0],0),s.setEnd(p[0].childNodes[0],p.text().length),a.removeAllRanges(),void a.addRange(s)}if(o.is("span")&&$(s.cloneContents()).text()==o.text()){var C=o.attr("data-id"),w=spans[C];return e?(t?w.features.add(e):w.features.remove(e),w.css(w.features.forEveryBrowser())):c&&w.css(c),void fontPreviewElement()[0].normalize()}var b=$(a.anchorNode.parentNode);if(b.is("span")&&b.parent().is("#font-preview")){var E=spans[b.attr("data-id")],N=E.text().slice(0,a.anchorOffset),k=E.text().slice(a.focusOffset,E.text().length),g=$(s.cloneContents()).text(),m=E.css(styleKeys());N&&createSpanWith(N,E.features,m).insertBefore(E),k&&createSpanWith(k,E.features,m).insertAfter(E),e&&(t?E.features.add(e):E.features.remove(e));w=createSpanWith(g,E.features,$.extend(m,c));return E.replaceWith(w),select(w[0]),void fontPreviewElement()[0].normalize()}h=setupFeatures();e&&(t?h.add(e):h.remove(e));w=createSpanWith("",h,c);s.surroundContents(w[0]),select(w[0]),fontPreviewElement()[0].normalize()}}function setupSelectionForFeatureAppliance(){var e=window.getSelection();0==e.rangeCount&&e.addRange(document.createRange());var t=e.getRangeAt(0);return e.isCollapsed&&selectWholeText(e,t),{selection:e,range:t}}function selectWholeText(e,t){var n=fontPreviewElement().contents().length,r=fontPreviewElement()[0].childNodes[n-1];t.setStart(fontPreviewElement()[0].childNodes[0],0),$(r).is("span")&&(r=r.childNodes[0]),t.setEnd(r,$(r).text().length),e.removeAllRanges(),e.addRange(t)}function isBackwards(e){var t=!1,n=document.createRange();return n.setStart(e.anchorNode,e.anchorOffset),n.setEnd(e.focusNode,e.focusOffset),t=n.collapsed,n.detach(),t}function createSpanWith(e,t,n){var r=t||setupFeatures(),a="span_"+globalId++,s=$("<span/>").attr("data-id",a);return spans[a]=s,n&&s.css(n),$.extend(s,{features:r}),s.text(e).css(s.features.forEveryBrowser()),s}function select(e){var t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}function displayActiveStyles(){var e=window.getSelection();if(0!=e.rangeCount){var t=$(e.anchorNode),n=$(e.focusNode);if(isBackwards(e)){var r=t;t=n,n=r;var a=e.getRangeAt(0);e.removeAllRanges(),e.addRange(a)}for(t.parent().is("span")&&(t=t.parent()),n.parent().is("span")&&(n=n.parent());!t.is(n);)if((t.is("span")?t.attr("style"):"")!=((t=$(t[0].nextSibling)).is("span")?t.attr("style"):""))return void checkActivated();t.is("span")?checkActivated(t.css(styleKeys())):checkActivated()}}function checkActivated(e,t){if(e=e||{},t=t||featureCheckboxes,Object.keys(styleCheckboxes).forEach(function(t){e[t]&&e[t]==styleCheckboxes[t].appliedValue?styleCheckboxes[t].prop("checked",!0):styleCheckboxes[t].prop("checked",!1)},this),Object.keys(t).forEach(function(n){e[n]?t[n].prop("checked",!0):t[n].prop("checked",!1)},this),e["font-weight"]){var n="700"==e["font-weight"]?"bold":e["font-weight"];$("#font-weights").val("font-weight: "+n)}else $("#font-weights").val("font-weight: 400");if(e["font-feature-settings"]){e["font-feature-settings"].split(",").forEach(function(e){var n=e.match(/['"]\S*['"]/gi)[0].replace(/['"]/g,"").trim(),r="0"!=e.slice(-1);" off"==e.slice(-4)&&(r=!1),t[n].prop("checked",r)},this)}}function pasteTextOnly(e){e.stopPropagation(),e.preventDefault();var t=window.getSelection();if(0!=t.rangeCount&&t.isCollapsed){var n=(e.clipboardData||e.originalEvent.clipboardData||window.clipboardData).getData("Text"),r=t.anchorOffset,a=$(t.anchorNode);if(a.is("#font-preview")){var s=fontPreviewElement();if(0==s.text().length)return fontPreviewElement().text(n),void setTimeout(function(){moveCursor(t,fontPreviewElement()[0].childNodes[0],r+n.length)},50);var o=t.getRangeAt(0);o.setStart(s[0].childNodes[0],0),o.setEnd(s[0].childNodes[0],0),t.removeAllRanges(),t.addRange(o)}var i=a.text(),l=i.slice(0,t.anchorOffset)+n+i.slice(t.anchorOffset,i.length);t.anchorNode.nodeValue=l,fontPreviewElement()[0].normalize(),setTimeout(function(){moveCursor(t,t.anchorNode,r+n.length)},50)}}function moveCursor(e,t,n){var r=e.getRangeAt(0);r.setStart(t,n),r.setEnd(t,n),e.removeAllRanges(),e.addRange(r)}function splitLettersInSpans(){var e=$("#font-preview");e.designMode="on",$(".feature-checkbox").each(function(e,t){var n=t.value;featureCheckboxes[n]=$(t)}),$(".style-checkbox").each(function(e,t){var n=t.value.split(":")[0].trim(),r=t.value.split(":")[1].trim();styleCheckboxes[n]=$.extend($(t),{appliedValue:r})}),e.keydown(function(){displayActiveStyles()}),e.on("mouseup",function(){setTimeout(displayActiveStyles,50)}),e.on("paste",pasteTextOnly)}function surroundTextInSpan(e,t){var n="letter_"+globalId++,r=$("<span/>").attr("data-id",n).text(t);return e.text(""),e.prepend(r),letters[n]=r,r}function theContenteditableElementIsEmpty(e){return"font-preview"==$(getCurrentNode()).attr("id")}function adjustCursorAfterLineBreak(e){var t=window.getSelection(),n=document.createRange(),r=e.next();r[0]?n.setStart(r[0].childNodes[0],0):n.setStart(e[0].childNodes[0],0),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function breakLine(){var e=window.getSelection();if(0!=e.rangeCount){var t=$(getCurrentNode()),n=$(getEndNode());t.is("br")&&(t=t.parent());var r=$("<br/>");if(e.isCollapsed){var a="letter_"+globalId++,s=$("<span/>").attr("data-id",a).append(r);return t.prev()[0]&&1==t.prev()[0].childNodes[0].nodeType?(0==e.getRangeAt(0).startOffset?s.insertBefore(t):s.insertAfter(t),letters[a]=s,void adjustCursorAfterLineBreak(s)):t.prev()[0]?(t.is("br")&&(t=t.parent()),s.insertAfter(t),letters[a]=s,void adjustCursorAfterLineBreak(s)):(s.insertBefore(t),letters[a]=s,void adjustCursorAfterLineBreak(s))}if(t.is(n))return t.text(""),t.append(r),void adjustCursorAfterLineBreak(t);t.prev();var o=t;for((weAreInEdge()||weAreInIE())&&(t,o=t.next()),t.is("br")&&(t=t.parent());!o.is(n);){var i=o.next();o.remove(),o=i}o.remove();a="letter_"+globalId++;(s=$("<span/>").attr("data-id",a).append(r)).insertAfter(t),letters[a]=s,adjustCursorAfterLineBreak(s)}}function splitNodeTextInSpans(e,t){if(0!=(d=window.getSelection()).rangeCount){var n=$(e);if(weAreInIE()&&n.is("br")){var r=n.text();n.text(""),(n=n.parent()).text(r),n.append("<br/>")}var a=t||!1;n.prev()[0]&&!/<br>/.test(n.prev().html())&&1!=n[0].childNodes[0].nodeType||1==d.getRangeAt(0).startOffset&&(a=!0);var s=!1,o=!1;/<br>$/.test(n.html())&&(s=!0),/<br>\S+/.test(n.html())&&(o=!0);var i=n.text().length||1,l=n.text().slice(1,i).split("");if(n.text(n.text().slice(0,1)),$(l).each(function(e,t){var r="letter_"+globalId++,a=" "===t?"&nbsp;":t,s=$("<span/>").attr("data-id",r).html(a).css(currentStyles);s.insertAfter(n),letters[r]=s,n=s}),s){f="letter_"+globalId++;(c=$("<span/>").attr("data-id",f).append("<br/>")).insertAfter(n),letters[f]=c}if(o){var f="letter_"+globalId++,c=$("<span/>").attr("data-id",f).append("<br/>");c.insertBefore(n),letters[f]=c}var d=window.getSelection(),u=document.createRange();a&&n.prev()[0]?/<br>/.test(n.prev().html())?u.setStart(n[0].childNodes[0],1):u.setStart(n.prev()[0].childNodes[0],1):u.setStart(n[0].childNodes[0],1),u.collapse(!1),d.removeAllRanges(),d.addRange(u)}}function featureCheckboxClicked(e){e.checked?applyFeatureStyles(e.value,!0):applyFeatureStyles(e.value,!1)}function styleCheckboxClicked(e){e.checked?applyFeatureStyles(void 0,!0,e.value):applyFeatureStyles(void 0,!1,e.value)}function changeFontStyle(e){applyFeatureStyles(void 0,!0,e.target.value)}function changeFont(e){fontPreviewElement().css("font-family",e.target.value)}function justify(e){fontPreviewElement().css("text-align",e)}function changeLineHeight(e){var t=e.target.value/10;fontPreviewElement().css("line-height",t)}function changeFontSize(e){var t=e.target.value;t>100&&(t=100+10*(t-100)),fontPreviewElement().css("font-size",t+"px")}function getEndNode(){var e=window.getSelection().getRangeAt(0);return rangeSelectsSingleNode(e)?e.startContainer.childNodes[e.startOffset]:3===e.endContainer.nodeType?e.endContainer.parentNode:e.endContainer}function getCurrentNode(){var e=window.getSelection().getRangeAt(0);return rangeSelectsSingleNode(e)?e.startContainer.childNodes[e.startOffset]:3===e.startContainer.nodeType?e.startContainer.parentNode:e.startContainer}function rangeSelectsSingleNode(e){var t=e.startContainer;return t===e.endContainer&&t.hasChildNodes()&&e.endOffset===e.startOffset+1}function weAreInIE(){return!!document.documentMode}function weAreInEdge(){return/Edge/.test(navigator.userAgent)}function weAreInFirefox(){return/Firefox/.test(navigator.userAgent)}var features=setupFeatures(),featureCheckboxes={},styleCheckboxes={},fontWeightsSelect={},letters={},spans={},currentStyles={},globalId=0;
